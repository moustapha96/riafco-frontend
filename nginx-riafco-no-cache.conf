# Configuration Nginx pour riafco-oi.org ‚Äì SANS CACHE (changements instantan√©s)
# √Ä placer sur le VPS : /etc/nginx/sites-available/riafco-oi.org
# Puis : sudo nginx -t && sudo systemctl reload nginx

server {
    server_name riafco-oi.org www.riafco-oi.org;

    root /home/adminadie/apps/riafco-frontend/build;
    index index.html;

    client_max_body_size 20m;
    sendfile on;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript application/xml+rss image/svg+xml;

    # Pour les challenges Let's Encrypt (au cas o√π)
    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        root /var/www/certbot;
    }

    # index.html : JAMAIS de cache ‚Üí les visiteurs r√©cup√®rent toujours la derni√®re version
    location = /index.html {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }

    # Assets statiques : pas de cache long pour voir les changements tout de suite
    # (JS/CSS/‚Ä¶ sans cache ; images/fonts avec cache court optionnel)
    location ~* \.(css|js|mjs)$ {
        access_log off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }

    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp|woff2?|ttf)$ {
        access_log off;
        add_header Cache-Control "public, max-age=300";  # 5 min pour images/fonts
        add_header X-Content-Type-Options "nosniff" always;
        try_files $uri =404;
    }

    # üëâ Rendre accessible tout le dossier uploads
    location /uploads/ {
        alias /home/adminadie/apps/backend-riafco/uploads/;
        autoindex off;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ Raccourci : /activities ‚Üí /uploads/activities
    location /activities/ {
        alias /home/adminadie/apps/backend-riafco/uploads/activities/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /about-us
    location /about-us/ {
        alias /home/adminadie/apps/backend-riafco/uploads/about-us/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /news
    location /news/ {
        alias /home/adminadie/apps/backend-riafco/uploads/news/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /flags
    location /flags/ {
        alias /home/adminadie/apps/backend-riafco/uploads/flags/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /profiles
    location /profiles/ {
        alias /home/adminadie/apps/backend-riafco/uploads/profiles/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /resources
    location /resources/ {
        alias /home/adminadie/apps/backend-riafco/uploads/resources/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # üëâ /reports
    location /reports/ {
        alias /home/adminadie/apps/backend-riafco/uploads/reports/;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Cache-Control "public, max-age=300";
    }

    # SPA fallback ‚Äì UN SEUL bloc location /
    location / {
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
        add_header Pragma "no-cache";
        try_files $uri $uri/ /index.html;
    }

    # Headers de s√©curit√©
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' https://back.riafco-oi.org data:; font-src 'self' https://fonts.gstatic.com data: blob:  ; connect-src 'self' https://admin.riafco-oi.org https://back.riafco-oi.org; frame-src https://www.google.com https://www.google.com/maps https://maps.google.com https://www.google.com/recaptcha/; frame-ancestors 'none'; object-src 'none'; base-uri 'self'; form-action 'self';" always;

    # HTTPS (Certbot)
    listen 443 ssl;                   # managed by Certbot
    listen [::]:443 ssl ipv6only=on;  # managed by Certbot
    ssl_certificate     /etc/letsencrypt/live/riafco-oi.org/fullchain.pem; # managed by Certbot
    ssl_certificate_key  /etc/letsencrypt/live/riafco-oi.org/privkey.pem;   # managed by Certbot
    include              /etc/letsencrypt/options-ssl-nginx.conf;           # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# Redirection HTTP -> HTTPS (bloc g√©n√©r√© par Certbot)
server {
    if ($host = www.riafco-oi.org) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = riafco-oi.org) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name riafco-oi.org www.riafco-oi.org;
    return 404; # managed by Certbot
}
